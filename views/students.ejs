<%- include('partials/header', { active: 'student-dashboard' }) %>

<div class="p-[32px]">

  <!-- Back + Context -->
  <div class="flex items-center justify-between mb-[16px]">
    <div class="flex items-center gap-[12px]">
      <a href="/student-count" class="bg-transparent text-[#64748b] border border-[#e2e8f0] inline-flex items-center gap-[6px]
        py-[8px] px-[16px] rounded-[8px] text-[0.85rem] font-[500] cursor-pointer
        transition-all duration-[150ms] ease-in-out hover:bg-[#f1f5f9] hover:text-[#1e293b]" style="text-decoration:none;font-family:var(--font-main)">
        <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>
        Back
      </a>
      <h2 class="text-[1.1rem] font-[600] text-[#1e293b]" id="pageTitle">Student Roster</h2>
    </div>
    <button onclick="expCSV()" id="expBtn" style="display:none;font-family:var(--font-main)" class="bg-[var(--primary-color)] text-white border-none inline-flex items-center gap-[8px]
      py-[8px] px-[16px] rounded-[8px] text-[0.85rem] font-[500] cursor-pointer
      transition-all duration-[150ms] ease-in-out hover:bg-[var(--primary-hover)]">
      <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
      Export CSV
    </button>
  </div>

  <!-- Context breadcrumb bar -->
  <div id="ctxBar" class="flex bg-[#1e293b] rounded-[12px] px-[24px] py-[16px] mb-[24px] gap-[32px]" style="display:none">
    <div class="flex flex-col gap-[2px]">
      <span class="text-[0.7rem] text-[#94a3b8] uppercase tracking-[0.05em]">SCHOOL</span>
      <span class="text-[1rem] font-[600] text-white" id="cSchool">-</span>
    </div>
    <div class="flex flex-col gap-[2px]">
      <span class="text-[0.7rem] text-[#94a3b8] uppercase tracking-[0.05em]">PROGRAM</span>
      <span class="text-[1rem] font-[600] text-white" id="cProgram">-</span>
    </div>
    <div class="flex flex-col gap-[2px]">
      <span class="text-[0.7rem] text-[#94a3b8] uppercase tracking-[0.05em]">COHORT</span>
      <span class="text-[1rem] font-[600] text-white" id="cCohort">-</span>
    </div>
    <div class="flex flex-col gap-[2px]">
      <span class="text-[0.7rem] text-[#94a3b8] uppercase tracking-[0.05em]">DIVISION</span>
      <span class="text-[0.85rem] font-[600]" style="color:#34d399" id="cDiv">-</span>
    </div>
    <div class="flex flex-col gap-[2px]">
      <span class="text-[0.7rem] text-[#94a3b8] uppercase tracking-[0.05em]">STUDENTS</span>
      <span class="text-[1rem] font-[700] text-white" id="cCount">0</span>
    </div>
  </div>

  <!-- Search -->
  <div id="searchRow" class="filters-container" style="display:none">
    <div style="display:flex;align-items:center;gap:16px">
      <div class="filter-item" style="flex:1;max-width:400px">
        <label>üîç SEARCH</label>
        <input type="text" id="sInp" placeholder="Search by name, email, roll number..." class="filter-input" oninput="filt()">
      </div>
    </div>
  </div>

  <!-- Table -->
  <div id="tableWrap" class="bg-white border border-[var(--border-light)] rounded-[8px] overflow-hidden" style="display:none;box-shadow:var(--shadow-card)">
    <div style="overflow-x:auto">
      <table style="width:100%;border-collapse:collapse;font-size:13px">
        <thead>
          <tr style="background:var(--bg-secondary);border-bottom:2px solid var(--border-color)">
            <th style="padding:12px 16px;text-align:left;font-size:11px;font-weight:600;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:0.5px">#</th>
            <th style="padding:12px 16px;text-align:left;font-size:11px;font-weight:600;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:0.5px">Roll No</th>
            <th style="padding:12px 16px;text-align:left;font-size:11px;font-weight:600;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:0.5px">Enrollment</th>
            <th style="padding:12px 16px;text-align:left;font-size:11px;font-weight:600;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:0.5px">Student Name</th>
            <th style="padding:12px 16px;text-align:left;font-size:11px;font-weight:600;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:0.5px">Email</th>
            <th style="padding:12px 16px;text-align:left;font-size:11px;font-weight:600;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:0.5px">Mobile</th>
            <th style="padding:12px 16px;text-align:left;font-size:11px;font-weight:600;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:0.5px">Division</th>
          </tr>
        </thead>
        <tbody id="tb"></tbody>
      </table>
    </div>
  </div>

  <!-- Placeholder when no class selected -->
  <div id="placeholder" class="empty-state">
    <div class="empty-icon">üë•</div>
    <h3>No class selected</h3>
    <p>Select a class from the Dashboard or Division view to see students</p>
  </div>

  <!-- Loading State -->
  <div id="loadingState" class="loading-state" style="display:none">
    <div class="spinner"></div>
    <p>Loading students...</p>
  </div>

</div>

<script>
let all = [];

async function init() {
  const p = new URLSearchParams(location.search);
  const cid = p.get('class_id'), ay = p.get('academic_year_id');
  if (!cid) return;

  const sc = p.get('school'), pr = p.get('program'), co = p.get('cohort');
  const cn = decodeURIComponent(p.get('class_name') || '');

  document.getElementById('pageTitle').textContent = 'Students ‚Äî ' + cn;
  if (sc) {
    document.getElementById('cSchool').textContent = decodeURIComponent(sc);
    document.getElementById('cProgram').textContent = decodeURIComponent(pr || '');
    document.getElementById('cCohort').textContent = decodeURIComponent(co || '');
    document.getElementById('cDiv').textContent = cn;
    document.getElementById('ctxBar').style.display = 'flex';
  }

  document.getElementById('placeholder').style.display = 'none';
  document.getElementById('loadingState').style.display = 'block';

  try {
    const q = ay ? '?academic_year_id=' + ay : '';
    const r = await fetch('/api/students/' + cid + q);
    const d = await r.json();
    document.getElementById('loadingState').style.display = 'none';
    if (d.success) {
      all = d.data;
      document.getElementById('cCount').textContent = all.length;
      document.getElementById('searchRow').style.display = 'block';
      document.getElementById('tableWrap').style.display = 'block';
      document.getElementById('expBtn').style.display = 'inline-flex';
      ren(all);
    }
  } catch (e) {
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('tb').innerHTML = '<tr><td colspan="7" style="padding:40px;text-align:center;color:var(--danger-color)">' + e.message + '</td></tr>';
  }
}

function ren(s) {
  const tb = document.getElementById('tb');
  if (!s.length) {
    tb.innerHTML = '<tr><td colspan="7" style="padding:40px;text-align:center;color:var(--text-tertiary)">No students found</td></tr>';
    return;
  }
  tb.innerHTML = s.map((x, i) =>
    '<tr style="border-bottom:1px solid var(--border-light);transition:background .15s" onmouseover="this.style.background=\'var(--bg-secondary)\'" onmouseout="this.style.background=\'transparent\'">' +
    '<td style="padding:10px 16px;color:var(--text-tertiary);font-size:12px">' + (i + 1) + '</td>' +
    '<td style="padding:10px 16px;font-size:12px;color:var(--text-secondary)">' + (x.student_roll_number || '-') + '</td>' +
    '<td style="padding:10px 16px;font-size:12px;color:var(--text-secondary)">' + (x.student_enrollment_number || '-') + '</td>' +
    '<td style="padding:10px 16px;font-weight:500;color:var(--text-primary)">' + x.student_name + '</td>' +
    '<td style="padding:10px 16px;font-size:12px;color:var(--text-secondary)">' + (x.student_email || '-') + '</td>' +
    '<td style="padding:10px 16px;font-size:12px;color:var(--text-secondary)">' + (x.student_mobile || '-') + '</td>' +
    '<td style="padding:10px 16px"><span style="font-size:11px;font-weight:600;padding:4px 10px;border-radius:4px;background:var(--bg-tertiary);color:var(--text-secondary)">' + (x.st_class_name || '-') + '</span></td>' +
    '</tr>'
  ).join('');
}

function filt() {
  const q = document.getElementById('sInp').value.toLowerCase().trim();
  if (!q) { ren(all); return; }
  ren(all.filter(s =>
    (s.student_name || '').toLowerCase().includes(q) ||
    (s.student_email || '').toLowerCase().includes(q) ||
    (s.student_roll_number || '').toString().includes(q) ||
    (s.student_enrollment_number || '').toString().includes(q) ||
    (s.student_mobile || '').toString().includes(q)
  ));
}

function expCSV() {
  if (!all.length) return;
  const h = ['#','Roll No','Enrollment','Name','Email','Mobile','Division'];
  const rows = all.map((s, i) => [i + 1, s.student_roll_number || '', s.student_enrollment_number || '', s.student_name, s.student_email || '', s.student_mobile || '', s.st_class_name || '']);
  const csv = [h, ...rows].map(r => r.map(c => '"' + String(c).replace(/"/g, '""') + '"').join(',')).join('\n');
  const b = new Blob([csv], { type: 'text/csv' });
  const u = URL.createObjectURL(b);
  const a = document.createElement('a'); a.href = u; a.download = 'students.csv'; a.click();
  URL.revokeObjectURL(u);
}

init();
</script>

  </div>
</div>
</body>
</html>
