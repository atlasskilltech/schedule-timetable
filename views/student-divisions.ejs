<%- include('partials/header', { active: 'student-divisions' }) %>

<div class="p-[32px]">

  <!-- Filters -->
  <div class="filters-container">
    <div class="filter-grid" style="grid-template-columns: repeat(4, 1fr);">
      <div class="filter-item">
        <label>üè´ SCHOOL</label>
        <select id="fSch" class="filter-select" onchange="ldPr()">
          <option value="">Select School</option>
        </select>
      </div>
      <div class="filter-item">
        <label>üìö PROGRAM</label>
        <select id="fPr" class="filter-select" disabled onchange="ldCo()">
          <option value="">Select Program</option>
        </select>
      </div>
      <div class="filter-item">
        <label>üéì COHORT</label>
        <select id="fCo" class="filter-select" disabled onchange="ldDv()">
          <option value="">Select Cohort</option>
        </select>
      </div>
      <div class="filter-item">
        <label>üìã DIVISION</label>
        <select id="fDv" class="filter-select" disabled onchange="goDv()">
          <option value="">Select Division</option>
        </select>
      </div>
    </div>
    <button class="bg-slate-100 text-slate-800 border border-slate-200 inline-flex items-center gap-2 px-4 py-2 rounded-lg
      text-[0.85rem] font-medium cursor-pointer transition-all duration-[150ms] ease-in-out h-fit whitespace-nowrap" onclick="location.reload()">Reset</button>
  </div>

  <input type="hidden" id="fAY" value="">

  <!-- Division Cards -->
  <div id="divCards" class="class-cards-grid" style="display:none"></div>

  <!-- Loading State -->
  <div id="loadingState" class="loading-state" style="display:none">
    <div class="spinner"></div>
    <p>Loading divisions...</p>
  </div>

  <!-- Empty/Initial State -->
  <div id="emptyState" class="empty-state">
    <div class="empty-icon">üìã</div>
    <h3>No division selected</h3>
    <p>Select School ‚Üí Program ‚Üí Cohort to view divisions</p>
  </div>

</div>

<script>
const COLORS = ['#16A085','#3b82f6','#8b5cf6','#f59e0b','#ec4899','#06b6d4'];

async function af(u) {
  const ay = document.getElementById('fAY').value;
  const s = u.includes('?') ? '&' : '?';
  return (await (await fetch('/api/' + u + s + 'academic_year_id=' + ay)).json()).data;
}

async function init() {
  const [ac, sc] = await Promise.all([af('filters/academic-years'), af('filters/schools')]);
  if (ac.length) document.getElementById('fAY').value = ac[ac.length - 1].academic_year_id;
  document.getElementById('fSch').innerHTML = '<option value="">Select School</option>' +
    sc.map(s => '<option value="' + s.school_id + '">' + s.school_name + '</option>').join('');
}

function rst(f) {
  if (f === 'prog') {
    document.getElementById('fPr').innerHTML = '<option value="">Select Program</option>';
    document.getElementById('fPr').disabled = true;
  }
  document.getElementById('fCo').innerHTML = '<option value="">Select Cohort</option>';
  document.getElementById('fCo').disabled = true;
  document.getElementById('fDv').innerHTML = '<option value="">Select Division</option>';
  document.getElementById('fDv').disabled = true;
  document.getElementById('divCards').style.display = 'none';
  document.getElementById('emptyState').style.display = 'block';
  document.getElementById('emptyState').querySelector('h3').textContent = 'No division selected';
  document.getElementById('emptyState').querySelector('p').textContent = 'Select School ‚Üí Program ‚Üí Cohort to view divisions';
}

async function ldPr() {
  rst('prog');
  const sid = document.getElementById('fSch').value;
  if (!sid) return;
  const pr = await af('filters/programs/' + sid);
  const p = document.getElementById('fPr');
  p.innerHTML = '<option value="">Select Program</option>' + pr.map(x => '<option value="' + x.program_id + '">' + x.program_name + '</option>').join('');
  p.disabled = false;
}

async function ldCo() {
  rst('cohort');
  const sid = document.getElementById('fSch').value, pid = document.getElementById('fPr').value;
  if (!pid) return;
  const co = await af('filters/cohorts/' + sid + '/' + pid);
  const c = document.getElementById('fCo');
  c.innerHTML = '<option value="">Select Cohort</option>' + co.map(x => '<option value="' + x.cluster_id + '">' + x.cluster_name + '</option>').join('');
  c.disabled = false;
}

async function ldDv() {
  document.getElementById('fDv').innerHTML = '<option value="">Select Division</option>';
  document.getElementById('fDv').disabled = true;
  const cid = document.getElementById('fCo').value;
  if (!cid) { rst('cohort'); return; }

  document.getElementById('emptyState').style.display = 'none';
  document.getElementById('loadingState').style.display = 'block';

  const cls = await af('classes/' + cid);

  document.getElementById('loadingState').style.display = 'none';

  // Populate dropdown
  document.getElementById('fDv').innerHTML = '<option value="">Select Division</option>' +
    cls.map(x => '<option value="' + x.st_class_id + '">' + x.st_class_name + ' (' + x.cnt + ')</option>').join('');
  document.getElementById('fDv').disabled = false;

  if (!cls.length) {
    document.getElementById('emptyState').style.display = 'block';
    document.getElementById('emptyState').querySelector('h3').textContent = 'No divisions found';
    document.getElementById('emptyState').querySelector('p').textContent = 'This cohort has no divisions';
    return;
  }

  // Show cards
  const g = document.getElementById('divCards');
  g.style.display = 'grid';
  var sc = document.getElementById('fSch').selectedOptions[0]?.text || '';
  var pr = document.getElementById('fPr').selectedOptions[0]?.text || '';
  var co = document.getElementById('fCo').selectedOptions[0]?.text || '';
  g.innerHTML = cls.map((cl, i) => {
    const col = COLORS[i % COLORS.length];
    return '<div class="class-card" onclick="goSt(' + cl.st_class_id + ',\'' + encodeURIComponent(cl.st_class_name) + '\')" style="cursor:pointer">' +
      '<div class="card-subject">' +
        '<span class="subject-badge" style="background:' + col + '">' + (cl.st_class_code || 'D') + '</span>' +
        '<div class="subject-name">' + cl.st_class_name + '</div>' +
      '</div>' +
      '<div class="card-info">' +
        '<div class="card-info-row"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg><span>' + cl.cnt.toLocaleString() + ' Students</span></div>' +
        '<div class="card-info-row"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16"/><path d="M3 21h18"/></svg><span>' + sc + '</span></div>' +
        '<div class="card-info-row"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z"/></svg><span>' + pr + '</span></div>' +
        '<div class="card-info-row"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg><span>' + co + '</span></div>' +
        '<div class="card-info-row"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m9 5 7 7-7 7"/></svg><span style="color:var(--primary-color);font-weight:500">View students</span></div>' +
      '</div>' +
    '</div>';
  }).join('');
}

function goSt(cid, cn) {
  const ay = document.getElementById('fAY').value;
  const sc = document.getElementById('fSch').selectedOptions[0]?.text || '';
  const pr = document.getElementById('fPr').selectedOptions[0]?.text || '';
  const co = document.getElementById('fCo').selectedOptions[0]?.text || '';
  window.location.href = '/student-count/students?class_id=' + cid + '&class_name=' + cn +
    '&school=' + encodeURIComponent(sc) + '&program=' + encodeURIComponent(pr) +
    '&cohort=' + encodeURIComponent(co) + '&academic_year_id=' + ay;
}

function goDv() {
  const v = document.getElementById('fDv').value;
  if (v) goSt(v, encodeURIComponent(document.getElementById('fDv').selectedOptions[0]?.text || ''));
}

init();
</script>

  </div>
</div>
</body>
</html>
