<%- include('partials/header', { active: 'student-search' }) %>

<div class="p-[16px] md:p-[32px]">

  <!-- Search Filter -->
  <div class="filters-container">
    <div class="filter-grid" style="grid-template-columns: 1fr;">
      <div class="filter-item">
        <label>üîç SEARCH BY NAME, EMAIL, ROLL NO, ENROLLMENT NO, OR MOBILE</label>
        <input type="text" id="searchInput" placeholder="Type at least 2 characters to search..." autofocus class="filter-input" style="max-width:500px">
      </div>
    </div>
    <button class="bg-slate-100 text-slate-800 border border-slate-200 inline-flex items-center gap-2 px-4 py-2 rounded-lg
      text-[0.85rem] font-medium cursor-pointer transition-all duration-[150ms] ease-in-out h-fit whitespace-nowrap" onclick="clearSearch()">Clear</button>
  </div>

  <!-- Stats Bar -->
  <div id="statsBar" class="flex flex-wrap bg-[#1e293b] rounded-[12px] px-[16px] md:px-[24px] py-[12px] md:py-[16px] mb-[24px] gap-[16px] md:gap-[32px]" style="display:none">
    <div class="flex flex-col gap-[2px]">
      <span class="text-[0.7rem] text-[#94a3b8] uppercase tracking-[0.05em]">RESULTS</span>
      <span class="text-[1rem] font-[600] text-white" id="resultCount">0</span>
    </div>
    <div class="flex flex-col gap-[2px]">
      <span class="text-[0.7rem] text-[#94a3b8] uppercase tracking-[0.05em]">STATUS</span>
      <span class="inline-block bg-[rgba(16,185,129,0.2)] text-[#34d399] px-[10px] py-[2px] rounded-[4px] text-[0.75rem] font-[600]" id="statusLabel">READY</span>
    </div>
  </div>

  <!-- Export button row -->
  <div class="flex items-center justify-between mb-[16px]">
    <span class="text-[13px] text-[var(--text-secondary)] font-[500]" id="infoText">Type to start searching</span>
    <button onclick="expCSV()" id="expBtn" style="display:none;font-family:var(--font-main)" class="bg-[var(--primary-color)] text-white border-none inline-flex items-center gap-[8px]
      py-[8px] px-[16px] rounded-[8px] text-[0.85rem] font-[500] cursor-pointer
      transition-all duration-[150ms] ease-in-out hover:bg-[var(--primary-hover)]">
      <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
      Export CSV
    </button>
  </div>

  <!-- Initial State -->
  <div id="initialState" class="empty-state">
    <div class="empty-icon">üîç</div>
    <h3>Search for students</h3>
    <p>Enter a name, email, roll number, enrollment number, or mobile number</p>
  </div>

  <!-- Loading State -->
  <div id="loadingState" class="loading-state" style="display:none">
    <div class="spinner"></div>
    <p>Searching...</p>
  </div>

  <!-- No Results -->
  <div id="noResults" class="empty-state" style="display:none">
    <div class="empty-icon">üì≠</div>
    <h3>No students found</h3>
    <p id="noResultsText">Try a different search term</p>
  </div>

  <!-- Results Table -->
  <div id="resultsTable" class="bg-white border border-[var(--border-light)] rounded-[8px] overflow-hidden" style="display:none;box-shadow:var(--shadow-card)">
    <div style="overflow-x:auto">
      <table style="width:100%;border-collapse:collapse;font-size:13px">
        <thead>
          <tr style="background:var(--bg-secondary);border-bottom:2px solid var(--border-color)">
            <th style="padding:12px 16px;text-align:left;font-size:11px;font-weight:600;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:0.5px">#</th>
            <th style="padding:12px 16px;text-align:left;font-size:11px;font-weight:600;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:0.5px">Roll No</th>
            <th style="padding:12px 16px;text-align:left;font-size:11px;font-weight:600;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:0.5px">Enrollment</th>
            <th style="padding:12px 16px;text-align:left;font-size:11px;font-weight:600;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:0.5px">Student Name</th>
            <th style="padding:12px 16px;text-align:left;font-size:11px;font-weight:600;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:0.5px">Email</th>
            <th style="padding:12px 16px;text-align:left;font-size:11px;font-weight:600;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:0.5px">Mobile</th>
            <th style="padding:12px 16px;text-align:left;font-size:11px;font-weight:600;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:0.5px">Division</th>
            <th style="padding:12px 16px;text-align:left;font-size:11px;font-weight:600;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:0.5px">Program</th>
            <th style="padding:12px 16px;text-align:left;font-size:11px;font-weight:600;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:0.5px">School</th>
          </tr>
        </thead>
        <tbody id="tb"></tbody>
      </table>
    </div>
  </div>

</div>

<script>
let searchResults = [];
let debounceTimer = null;
let acYearId = 9;

async function init() {
  try {
    const r = await fetch('/api/filters/academic-years');
    const d = await r.json();
    if (d.success && d.data.length) acYearId = d.data[d.data.length - 1].academic_year_id;
  } catch (e) {}
  const p = new URLSearchParams(location.search);
  const q = p.get('q');
  if (q) {
    document.getElementById('searchInput').value = q;
    doSearch(q);
  }
}

document.getElementById('searchInput').addEventListener('input', function () {
  clearTimeout(debounceTimer);
  const q = this.value.trim();
  if (q.length < 2) {
    showState('initial');
    document.getElementById('infoText').textContent = 'Type to start searching';
    document.getElementById('expBtn').style.display = 'none';
    document.getElementById('statsBar').style.display = 'none';
    searchResults = [];
    return;
  }
  debounceTimer = setTimeout(() => doSearch(q), 350);
});

document.getElementById('searchInput').addEventListener('keydown', function (e) {
  if (e.key === 'Enter') {
    clearTimeout(debounceTimer);
    const q = this.value.trim();
    if (q.length >= 2) doSearch(q);
  }
});

async function doSearch(q) {
  showState('loading');
  try {
    const r = await fetch('/api/search/students?q=' + encodeURIComponent(q) + '&academic_year_id=' + acYearId);
    const d = await r.json();
    if (!d.success) throw new Error(d.message);
    searchResults = d.data;
    if (!searchResults.length) {
      document.getElementById('noResultsText').textContent = 'No results for "' + q + '"';
      showState('noResults');
      document.getElementById('infoText').textContent = '0 results';
      document.getElementById('expBtn').style.display = 'none';
      document.getElementById('statsBar').style.display = 'none';
    } else {
      renderResults(searchResults, q);
      showState('results');
      document.getElementById('infoText').textContent = searchResults.length + ' student(s) found';
      document.getElementById('expBtn').style.display = 'inline-flex';
      document.getElementById('statsBar').style.display = 'flex';
      document.getElementById('resultCount').textContent = searchResults.length;
      document.getElementById('statusLabel').textContent = 'FOUND';
    }
  } catch (e) {
    document.getElementById('noResultsText').textContent = 'Error: ' + e.message;
    showState('noResults');
    document.getElementById('infoText').textContent = 'Search failed';
  }
}

function showState(state) {
  document.getElementById('initialState').style.display = state === 'initial' ? 'block' : 'none';
  document.getElementById('loadingState').style.display = state === 'loading' ? 'block' : 'none';
  document.getElementById('noResults').style.display = state === 'noResults' ? 'block' : 'none';
  document.getElementById('resultsTable').style.display = state === 'results' ? 'block' : 'none';
}

function highlight(text, query) {
  if (!text || !query) return text || '-';
  const str = String(text);
  const idx = str.toLowerCase().indexOf(query.toLowerCase());
  if (idx === -1) return str;
  return str.substring(0, idx) + '<mark style="background:#d1fae5;color:var(--primary-color);padding:0 2px;border-radius:3px;font-weight:600">' + str.substring(idx, idx + query.length) + '</mark>' + str.substring(idx + query.length);
}

function renderResults(students, query) {
  const tb = document.getElementById('tb');
  tb.innerHTML = students.map((x, i) =>
    '<tr style="border-bottom:1px solid var(--border-light);transition:background .15s" onmouseover="this.style.background=\'var(--bg-secondary)\'" onmouseout="this.style.background=\'transparent\'">' +
    '<td style="padding:10px 16px;color:var(--text-tertiary);font-size:12px">' + (i + 1) + '</td>' +
    '<td style="padding:10px 16px;font-size:12px;color:var(--text-secondary)">' + highlight(x.student_roll_number, query) + '</td>' +
    '<td style="padding:10px 16px;font-size:12px;color:var(--text-secondary)">' + highlight(x.student_enrollment_number, query) + '</td>' +
    '<td style="padding:10px 16px;font-weight:500;color:var(--text-primary)">' + highlight(x.student_name, query) + '</td>' +
    '<td style="padding:10px 16px;font-size:12px;color:var(--text-secondary)">' + highlight(x.student_email, query) + '</td>' +
    '<td style="padding:10px 16px;font-size:12px;color:var(--text-secondary)">' + highlight(x.student_mobile, query) + '</td>' +
    '<td style="padding:10px 16px"><span style="font-size:11px;font-weight:600;padding:4px 10px;border-radius:4px;background:var(--bg-tertiary);color:var(--text-secondary)">' + (x.st_class_name || '-') + '</span></td>' +
    '<td style="padding:10px 16px;font-size:12px;color:var(--text-secondary)">' + (x.program_name || '-') + '</td>' +
    '<td style="padding:10px 16px;font-size:12px;color:var(--text-secondary)">' + (x.school_name || '-') + '</td>' +
    '</tr>'
  ).join('');
}

function clearSearch() {
  document.getElementById('searchInput').value = '';
  searchResults = [];
  showState('initial');
  document.getElementById('infoText').textContent = 'Type to start searching';
  document.getElementById('expBtn').style.display = 'none';
  document.getElementById('statsBar').style.display = 'none';
  document.getElementById('searchInput').focus();
}

function expCSV() {
  if (!searchResults.length) return;
  const h = ['#','Roll No','Enrollment','Name','Email','Mobile','Division','Program','School'];
  const rows = searchResults.map((s, i) => [i + 1, s.student_roll_number || '', s.student_enrollment_number || '', s.student_name, s.student_email || '', s.student_mobile || '', s.st_class_name || '', s.program_name || '', s.school_name || '']);
  const csv = [h, ...rows].map(r => r.map(c => '"' + String(c).replace(/"/g, '""') + '"').join(',')).join('\n');
  const b = new Blob([csv], { type: 'text/csv' });
  const u = URL.createObjectURL(b);
  const a = document.createElement('a'); a.href = u; a.download = 'search_results.csv'; a.click();
  URL.revokeObjectURL(u);
}

init();
</script>

  </div>
</div>
</body>
</html>
