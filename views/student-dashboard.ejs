<%- include('partials/header', { active: 'student-dashboard' }) %>

<div class="p-[32px]">

  <!-- Filters -->
  <div class="flex flex-wrap items-end gap-[4px] py-[8px] px-[16px] bg-[#ffffff] border border-[#e2e8f0] rounded-[12px] mb-[16px]">
    <div class="min-w-[100px] flex flex-col gap-[2px] shrink basis-auto grow-0" id="filterSchool"></div>
    <div class="min-w-[100px] flex flex-col gap-[2px] shrink basis-auto grow-0" id="filterDegree"></div>
    <div class="min-w-[100px] flex flex-col gap-[2px] shrink basis-auto grow-0" id="filterProgram"></div>
    <div class="min-w-[100px] flex flex-col gap-[2px] shrink basis-auto grow-0" id="filterGradYear"></div>
    <button class="bg-slate-100 text-slate-800 border border-slate-200 inline-flex items-center gap-2 px-4 py-2 rounded-lg text-[0.85rem] font-medium cursor-pointer transition-all duration-[150ms] ease-in-out h-fit whitespace-nowrap" id="clearFilters">Clear</button>
  </div>

  <!-- Stats Bar -->
  <div class="flex bg-[#1e293b] rounded-[12px] px-[24px] py-[16px] mb-[24px] gap-[32px]">
    <div class="flex flex-col gap-[2px]">
      <span class="text-[0.7rem] text-[#94a3b8] uppercase tracking-[0.05em]">TOTAL STUDENTS</span>
      <span class="text-[1rem] font-[600] text-white" id="totalStudents">0</span>
    </div>
    <div class="flex flex-col gap-[2px]">
      <span class="text-[0.7rem] text-[#94a3b8] uppercase tracking-[0.05em]">SCHOOLS</span>
      <span class="text-[1rem] font-[600] text-white" id="totalSchools">0</span>
    </div>
    <div class="flex flex-col gap-[2px]">
      <span class="text-[0.7rem] text-[#94a3b8] uppercase tracking-[0.05em]">PROGRAMS</span>
      <span class="text-[1rem] font-[600] text-white" id="totalPrograms">0</span>
    </div>
    <div class="flex flex-col gap-[2px]">
      <span class="text-[0.7rem] text-[#94a3b8] uppercase tracking-[0.05em]">GRADUATION YEARS</span>
      <span class="text-[1rem] font-[600] text-white" id="totalGradYears">0</span>
    </div>
  </div>

  <!-- Breadcrumb -->
  <div class="flex items-center justify-between mb-[16px]">
    <div id="breadcrumb" class="flex items-center gap-[8px] text-[13px]">
      <span class="font-[600] text-[var(--primary-color)] cursor-pointer">Schools</span>
    </div>
    <span class="text-[12px] text-[var(--text-tertiary)] font-[500]" id="resultCount"></span>
  </div>

  <!-- Cards Grid -->
  <div id="schoolsGrid" class="class-cards-grid"></div>
  <div id="programsGrid" class="class-cards-grid" style="display:none"></div>
  <div id="cohortsGrid" class="class-cards-grid" style="display:none"></div>
  <div id="classesGrid" class="class-cards-grid" style="display:none"></div>

  <!-- Loading State -->
  <div id="loadingState" class="loading-state" style="display:none;">
    <div class="spinner"></div>
    <p>Loading data...</p>
  </div>

  <!-- Empty State -->
  <div id="emptyState" class="empty-state" style="display:none;">
    <div class="empty-icon">ðŸ‘¥</div>
    <h3>No data found</h3>
    <p>Try adjusting your filters</p>
  </div>

</div>

<input type="hidden" id="fAcYear" value="">

<script>
const COLORS = ['#16A085','#3b82f6','#8b5cf6','#f59e0b','#ec4899','#06b6d4'];
let S = { level:'schools', curSchool:null, curProg:null, curCohort:null };
let fSchool = 'all', fDegree = 'all', fProgram = 'all', fGradYears = [];

// â”€â”€â”€ Multi-select dropdown toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleMultiSelect(displayEl) {
  const container = displayEl.parentElement;
  const wasOpen = container.classList.contains('open');
  document.querySelectorAll('.multi-select.open').forEach(ms => ms.classList.remove('open'));
  if (!wasOpen) container.classList.add('open');
}
document.addEventListener('click', (e) => {
  if (!e.target.closest('.multi-select')) {
    document.querySelectorAll('.multi-select.open').forEach(ms => ms.classList.remove('open'));
  }
});

function buildSelectDropdownHTML(label, placeholder, items, idPrefix) {
  let html = `
    <label class="flex items-center gap-[4px] text-[0.7rem] font-[600] text-[#94a3b8] uppercase tracking-[0.05em]">${label}</label>
    <div class="relative min-w-[120px] multi-select group">
      <div class="flex items-center justify-between py-[6px] px-[10px] bg-[#ffffff] border border-[#e2e8f0] rounded-[8px] cursor-pointer text-[0.85rem] min-h-[32px] gap-[4px] transition-all duration-[150ms] ease-in-out text-[#64748b] hover:border-[#10b981] group-[.open]:border-[#10b981] group-[.open]:ring-2 group-[.open]:ring-[rgba(16,185,129,0.1)]" onclick="toggleMultiSelect(this)">
        <span class="text-[#64748b] whitespace-nowrap overflow-hidden text-ellipsis" id="${idPrefix}HeaderText">${placeholder}</span>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-[14px] h-[14px] shrink-0 transition-transform duration-[150ms] ease-in-out text-[#94a3b8] group-[.open]:rotate-180"><polyline points="6 9 12 15 18 9"></polyline></svg>
      </div>
      <div class="absolute top-[calc(100%+4px)] left-0 right-0 bg-[#ffffff] border border-[#e2e8f0] rounded-[8px] shadow-[0_10px_15px_-3px_rgb(0_0_0_/_0.1),_0_4px_6px_-4px_rgb(0_0_0_/_0.1)] z-[1] max-h-[250px] overflow-y-auto hidden group-[.open]:block">`;
  html += `<div class="dropdown-option selected py-[8px] px-[12px] cursor-pointer text-[0.7rem] font-[600] text-[#1e293b] uppercase tracking-[0.05em] hover:bg-[#f1f5f9] transition-colors duration-[150ms] ease-in-out" data-value="all">${placeholder}</div>`;
  items.forEach(item => {
    html += `<div class="dropdown-option py-[8px] px-[12px] cursor-pointer text-[0.7rem] font-[600] text-[#94a3b8] uppercase tracking-[0.05em] hover:bg-[#f1f5f9] transition-colors duration-[150ms] ease-in-out" data-value="${item.value}">${item.label}</div>`;
  });
  html += `</div></div>`;
  return html;
}

function attachDropdownClick(container, filterKey, placeholder, callback) {
  container.addEventListener('click', (e) => {
    const option = e.target.closest('.dropdown-option');
    if (!option) return;
    const value = option.dataset.value;
    container.querySelectorAll('.dropdown-option').forEach(o => {
      o.classList.remove('selected', 'text-[#1e293b]');
      o.classList.add('text-[#94a3b8]');
    });
    option.classList.add('selected');
    option.classList.remove('text-[#94a3b8]');
    option.classList.add('text-[#1e293b]');
    document.getElementById(`${filterKey}HeaderText`).textContent = value === 'all' ? placeholder : option.textContent.trim();
    container.querySelector('.multi-select')?.classList.remove('open');
    if (callback) callback(value);
  });
}

function bq() {
  const p = new URLSearchParams();
  const ay = document.getElementById('fAcYear').value;
  if (ay) p.set('academic_year_id', ay);
  if (fSchool !== 'all') p.set('school_id', fSchool);
  if (fDegree !== 'all') p.set('degree_id', fDegree);
  if (fProgram !== 'all') p.set('program_abbr_id', fProgram);
  if (fGradYears.length) p.set('graduation_year_ids', fGradYears.join(','));
  return p.toString();
}

async function api(u) {
  const s = u.includes('?') ? '&' : '?';
  const r = await fetch('/api/' + u + s + bq());
  const d = await r.json();
  if (!d.success) throw new Error(d.message);
  return d.data;
}

const E = encodeURIComponent, D = decodeURIComponent;

async function init() {
  const [ac, gr, sc, dg, pr] = await Promise.all([
    api('filters/academic-years'), api('filters/graduation-years'),
    api('filters/schools'), api('filters/degrees'), api('filters/programs')
  ]);
  if (ac.length) document.getElementById('fAcYear').value = ac[ac.length - 1].academic_year_id;

  // Store all grad years as selected by default
  fGradYears = gr.map(y => String(y.graduation_year_id));

  // Build school dropdown
  const schoolEl = document.getElementById('filterSchool');
  schoolEl.innerHTML = buildSelectDropdownHTML('SCHOOL', 'All Schools', sc.map(s => ({ value: s.school_id, label: s.school_name })), 'school');
  attachDropdownClick(schoolEl, 'school', 'All Schools', v => { fSchool = v; onFilterChange(); });

  // Build degree dropdown
  const degreeEl = document.getElementById('filterDegree');
  degreeEl.innerHTML = buildSelectDropdownHTML('DEGREE', 'All Degrees', dg.map(d => ({ value: d.certification_id, label: d.certification_name + (d.certification_short_name ? ' (' + d.certification_short_name + ')' : '') })), 'degree');
  attachDropdownClick(degreeEl, 'degree', 'All Degrees', v => { fDegree = v; onFilterChange(); });

  // Build program dropdown
  const progEl = document.getElementById('filterProgram');
  progEl.innerHTML = buildSelectDropdownHTML('PROGRAM', 'All Programs', pr.map(p => ({ value: p.id, label: p.abbrivation })), 'program');
  attachDropdownClick(progEl, 'program', 'All Programs', v => { fProgram = v; onFilterChange(); });

  // Build graduation year dropdown
  const gradEl = document.getElementById('filterGradYear');
  gradEl.innerHTML = buildSelectDropdownHTML('GRAD YEAR', 'All Years', gr.map(y => ({ value: y.graduation_year_id, label: y.graduation_year_name })), 'gradYear');
  attachDropdownClick(gradEl, 'gradYear', 'All Years', v => {
    if (v === 'all') {
      fGradYears = gr.map(y => String(y.graduation_year_id));
    } else {
      fGradYears = [String(v)];
    }
    onFilterChange();
  });

  document.getElementById('totalSchools').textContent = sc.length;
  document.getElementById('totalPrograms').textContent = pr.length;
  document.getElementById('totalGradYears').textContent = gr.length;
  loadSummary();
  loadSchools();
}

function onFilterChange() { showLevel('schools'); loadSummary(); loadSchools(); }

document.getElementById('clearFilters').addEventListener('click', function() {
  fSchool = 'all'; fDegree = 'all'; fProgram = 'all';
  ['school', 'degree', 'program', 'gradYear'].forEach(key => {
    const ht = document.getElementById(key + 'HeaderText');
    if (ht) ht.textContent = key === 'school' ? 'All Schools' : key === 'degree' ? 'All Degrees' : key === 'program' ? 'All Programs' : 'All Years';
    const cId = key === 'school' ? 'filterSchool' : key === 'degree' ? 'filterDegree' : key === 'program' ? 'filterProgram' : 'filterGradYear';
    const c = document.getElementById(cId);
    if (c) {
      c.querySelectorAll('.dropdown-option').forEach(o => { o.classList.remove('selected', 'text-[#1e293b]'); o.classList.add('text-[#94a3b8]'); });
      const allOpt = c.querySelector('.dropdown-option[data-value="all"]');
      if (allOpt) { allOpt.classList.add('selected', 'text-[#1e293b]'); allOpt.classList.remove('text-[#94a3b8]'); }
    }
  });
  onFilterChange();
});

async function loadSummary() {
  try {
    const s = await api('summary');
    document.getElementById('totalStudents').textContent = (s.total_students || 0).toLocaleString();
  } catch (e) {}
}

function showLevel(lv) {
  S.level = lv;
  ['schoolsGrid','programsGrid','cohortsGrid','classesGrid'].forEach(id => {
    document.getElementById(id).style.display = 'none';
    document.getElementById(id).innerHTML = '';
  });
  document.getElementById(lv + 'Grid').style.display = 'grid';
  document.getElementById('loadingState').style.display = 'none';
  document.getElementById('emptyState').style.display = 'none';
  updateBC();
}

function chevHTML() {
  return '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--text-tertiary)" stroke-width="2.5" style="flex-shrink:0"><path d="m9 5 7 7-7 7"/></svg>';
}

function updateBC() {
  const b = document.getElementById('breadcrumb');
  let h = '<span style="cursor:pointer;font-weight:600;color:' + (S.level === 'schools' ? 'var(--primary-color)' : 'var(--text-tertiary)') + '" onclick="showLevel(\'schools\');loadSchools()">Schools</span>';
  if (['programs','cohorts','classes'].includes(S.level)) {
    h += chevHTML() + '<span style="cursor:pointer;font-weight:500;color:' + (S.level === 'programs' ? 'var(--text-primary)' : 'var(--text-tertiary)') + '" onclick="loadPrograms(' + S.curSchool.id + ',\'' + E(S.curSchool.name) + '\')">' + S.curSchool.name + '</span>';
  }
  if (['cohorts','classes'].includes(S.level)) {
    h += chevHTML() + '<span style="cursor:pointer;font-weight:500;color:' + (S.level === 'cohorts' ? 'var(--text-primary)' : 'var(--text-tertiary)') + '" onclick="loadCohorts(' + S.curSchool.id + ',' + S.curProg.id + ',\'' + E(S.curProg.name) + '\')">' + S.curProg.name + '</span>';
  }
  if (S.level === 'classes') {
    h += chevHTML() + '<span style="font-weight:600;color:var(--text-primary)">' + S.curCohort.name + '</span>';
  }
  b.innerHTML = h;
}

function mkCard(name, cnt, code, sub, click, i, extraRows) {
  const col = COLORS[i % COLORS.length];
  return '<div class="class-card" onclick="' + click + '" style="cursor:pointer" data-school="' + i + '">' +
    '<div class="card-subject">' +
      '<span class="subject-badge" style="background:' + col + '">' + (code || name.charAt(0)) + '</span>' +
      '<div class="subject-name">' + name + '</div>' +
    '</div>' +
    '<div class="card-info">' +
      '<div class="card-info-row">' +
        '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>' +
        '<span>' + cnt.toLocaleString() + ' Students</span>' +
      '</div>' +
      (extraRows || '') +
      '<div class="card-info-row">' +
        '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m9 5 7 7-7 7"/></svg>' +
        '<span style="color:var(--primary-color);font-weight:500">' + sub + '</span>' +
      '</div>' +
    '</div>' +
  '</div>';
}

function infoRow(icon, text) {
  var icons = {
    school: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16"/><path d="M3 21h18"/><path d="M9 7h1m-1 4h1m4-4h1m-1 4h1"/></svg>',
    program: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z"/></svg>',
    calendar: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>',
    grid: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>'
  };
  return '<div class="card-info-row">' + (icons[icon] || '') + '<span>' + text + '</span></div>';
}

function showLoading() {
  ['schoolsGrid','programsGrid','cohortsGrid','classesGrid'].forEach(id => document.getElementById(id).style.display = 'none');
  document.getElementById('emptyState').style.display = 'none';
  document.getElementById('loadingState').style.display = 'block';
}

function showEmpty(msg) {
  document.getElementById('loadingState').style.display = 'none';
  document.getElementById('emptyState').style.display = 'block';
  document.getElementById('emptyState').querySelector('h3').textContent = msg || 'No data found';
}

async function loadSchools() {
  showLoading();
  showLevel('schools');
  const g = document.getElementById('schoolsGrid');
  try {
    const d = await api('schools');
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('resultCount').textContent = d.length + ' school(s)';
    if (!d.length) { showEmpty('No schools found'); return; }
    g.style.display = 'grid';
    g.innerHTML = d.map((s, i) => mkCard(s.school_name, s.cnt, s.school_name.charAt(0), 'View programs', "loadPrograms(" + s.school_id + ",'" + E(s.school_name) + "')", i, infoRow('school', s.school_name))).join('');
  } catch (e) { showEmpty('Error: ' + e.message); }
}

async function loadPrograms(sid, sn) {
  sn = D(sn);
  S.curSchool = { id: sid, name: sn };
  showLoading();
  showLevel('programs');
  const g = document.getElementById('programsGrid');
  try {
    const d = await api('programs/' + sid);
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('resultCount').textContent = d.length + ' program(s)';
    if (!d.length) { showEmpty('No programs found'); return; }
    g.style.display = 'grid';
    g.innerHTML = d.map((p, i) => mkCard(p.program_name, p.cnt, p.program_code || 'P', 'View cohorts', "loadCohorts(" + sid + "," + p.program_id + ",'" + E(p.program_name) + "')", i, infoRow('school', S.curSchool.name) + infoRow('program', p.program_code || 'Program'))).join('');
  } catch (e) { showEmpty('Error: ' + e.message); }
}

async function loadCohorts(sid, pid, pn) {
  pn = D(pn);
  S.curProg = { id: pid, name: pn };
  showLoading();
  showLevel('cohorts');
  const g = document.getElementById('cohortsGrid');
  try {
    const d = await api('cohorts/' + sid + '/' + pid);
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('resultCount').textContent = d.length + ' cohort(s)';
    if (!d.length) { showEmpty('No cohorts found'); return; }
    g.style.display = 'grid';
    g.innerHTML = d.map((c, i) => mkCard(c.cluster_name, c.cnt, c.cluster_code || 'C', 'View divisions', "loadClasses(" + c.cluster_id + ",'" + E(c.cluster_name) + "')", i, infoRow('school', S.curSchool.name) + infoRow('program', S.curProg.name) + (c.graduation_year_name ? infoRow('calendar', 'Grad: ' + c.graduation_year_name) : ''))).join('');
  } catch (e) { showEmpty('Error: ' + e.message); }
}

async function loadClasses(cid, cn) {
  cn = D(cn);
  S.curCohort = { id: cid, name: cn };
  showLoading();
  showLevel('classes');
  const g = document.getElementById('classesGrid');
  try {
    const d = await api('classes/' + cid);
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('resultCount').textContent = d.length + ' division(s)';
    if (!d.length) { showEmpty('No divisions found'); return; }
    g.style.display = 'grid';
    g.innerHTML = d.map((cl, i) => mkCard(cl.st_class_name, cl.cnt, cl.st_class_code || 'D', 'View students', "goStudents(" + cl.st_class_id + ",'" + E(cl.st_class_name) + "')", i, infoRow('school', S.curSchool.name) + infoRow('program', S.curProg.name) + infoRow('grid', S.curCohort.name))).join('');
  } catch (e) { showEmpty('Error: ' + e.message); }
}

function goStudents(cid, cn) {
  window.location.href = '/student-count/students?class_id=' + cid + '&class_name=' + cn +
    '&school=' + E(S.curSchool.name) + '&program=' + E(S.curProg.name) +
    '&cohort=' + E(S.curCohort.name) + '&' + bq();
}

init();
</script>

  </div>
</div>
</body>
</html>
