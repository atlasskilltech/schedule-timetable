<%- include('partials/header', { active: 'student-dashboard' }) %>

<div class="p-[32px]">

  <!-- Filters -->
  <div class="filters-container">
    <div class="filter-grid" style="grid-template-columns: repeat(4, 1fr);">
      <div class="filter-item">
        <label>üè´ SCHOOL</label>
        <select id="fSchool" class="filter-select" onchange="onFilterChange()">
          <option value="">All Schools</option>
        </select>
      </div>
      <div class="filter-item">
        <label>üéì DEGREE</label>
        <select id="fDegree" class="filter-select" onchange="onFilterChange()">
          <option value="">All Degrees</option>
        </select>
      </div>
      <div class="filter-item">
        <label>üìö PROGRAM</label>
        <select id="fProgram" class="filter-select" onchange="onFilterChange()">
          <option value="">All Programs</option>
        </select>
      </div>
      <div class="filter-item">
        <label>üìÖ GRADUATION YEAR</label>
        <div style="position:relative">
          <button onclick="toggleGrad()" id="gradBtn" class="filter-select" type="button"
            style="display:flex;align-items:center;justify-content:space-between;cursor:pointer;text-align:left;height:38px">
            <span id="gradLabel" style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap">All Years</span>
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#94a3b8" stroke-width="2.5" style="flex-shrink:0;margin-left:4px"><path d="m6 9 6 6 6-6"/></svg>
          </button>
          <div id="gradDD" style="display:none;position:absolute;z-index:50;margin-top:4px;width:100%;background:#fff;border:1px solid var(--border-color);border-radius:8px;box-shadow:var(--shadow-lg)">
            <div style="max-height:200px;overflow-y:auto;padding:8px" id="gradOpts"></div>
            <div style="border-top:1px solid var(--border-light);padding:8px;display:flex;gap:8px">
              <button onclick="selAllGrad()" style="flex:1;font-size:11px;color:var(--primary-color);font-weight:600;background:none;border:none;cursor:pointer;padding:4px">All</button>
              <button onclick="clrGrad()" style="flex:1;font-size:11px;color:var(--text-tertiary);font-weight:600;background:none;border:none;cursor:pointer;padding:4px">Clear</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <button class="bg-slate-100 text-slate-800 border border-slate-200 inline-flex items-center gap-2 px-4 py-2 rounded-lg
      text-[0.85rem] font-medium cursor-pointer transition-all duration-[150ms] ease-in-out h-fit whitespace-nowrap" id="clearFilters" onclick="resetFilters()">Clear</button>
  </div>

  <!-- Stats Bar -->
  <div class="flex bg-[#1e293b] rounded-[12px] px-[24px] py-[16px] mb-[24px] gap-[32px]">
    <div class="flex flex-col gap-[2px]">
      <span class="text-[0.7rem] text-[#94a3b8] uppercase tracking-[0.05em]">TOTAL STUDENTS</span>
      <span class="text-[1rem] font-[600] text-white" id="totalStudents">0</span>
    </div>
    <div class="flex flex-col gap-[2px]">
      <span class="text-[0.7rem] text-[#94a3b8] uppercase tracking-[0.05em]">SCHOOLS</span>
      <span class="text-[1rem] font-[600] text-white" id="totalSchools">0</span>
    </div>
    <div class="flex flex-col gap-[2px]">
      <span class="text-[0.7rem] text-[#94a3b8] uppercase tracking-[0.05em]">PROGRAMS</span>
      <span class="text-[1rem] font-[600] text-white" id="totalPrograms">0</span>
    </div>
    <div class="flex flex-col gap-[2px]">
      <span class="text-[0.7rem] text-[#94a3b8] uppercase tracking-[0.05em]">GRADUATION YEARS</span>
      <span class="text-[1rem] font-[600] text-white" id="totalGradYears">0</span>
    </div>
  </div>

  <!-- Breadcrumb -->
  <div class="flex items-center justify-between mb-[16px]">
    <div id="breadcrumb" class="flex items-center gap-[8px] text-[13px]">
      <span class="font-[600] text-[var(--primary-color)] cursor-pointer">Schools</span>
    </div>
    <span class="text-[12px] text-[var(--text-tertiary)] font-[500]" id="resultCount"></span>
  </div>

  <!-- Cards Grid -->
  <div id="schoolsGrid" class="class-cards-grid"></div>
  <div id="programsGrid" class="class-cards-grid" style="display:none"></div>
  <div id="cohortsGrid" class="class-cards-grid" style="display:none"></div>
  <div id="classesGrid" class="class-cards-grid" style="display:none"></div>

  <!-- Loading State -->
  <div id="loadingState" class="loading-state" style="display:none;">
    <div class="spinner"></div>
    <p>Loading data...</p>
  </div>

  <!-- Empty State -->
  <div id="emptyState" class="empty-state" style="display:none;">
    <div class="empty-icon">üë•</div>
    <h3>No data found</h3>
    <p>Try adjusting your filters</p>
  </div>

</div>

<input type="hidden" id="fAcYear" value="">

<script>
const COLORS = ['#16A085','#3b82f6','#8b5cf6','#f59e0b','#ec4899','#06b6d4'];
let S = { level:'schools', curSchool:null, curProg:null, curCohort:null };

function bq() {
  const p = new URLSearchParams();
  const sc = document.getElementById('fSchool').value;
  const dg = document.getElementById('fDegree').value;
  const pr = document.getElementById('fProgram').value;
  const ay = document.getElementById('fAcYear').value;
  if (ay) p.set('academic_year_id', ay);
  if (sc) p.set('school_id', sc);
  if (dg) p.set('degree_id', dg);
  if (pr) p.set('program_abbr_id', pr);
  const g = [...document.querySelectorAll('.gc:checked')].map(c => c.value);
  if (g.length) p.set('graduation_year_ids', g.join(','));
  return p.toString();
}

async function api(u) {
  const s = u.includes('?') ? '&' : '?';
  const r = await fetch('/api/' + u + s + bq());
  const d = await r.json();
  if (!d.success) throw new Error(d.message);
  return d.data;
}

const E = encodeURIComponent, D = decodeURIComponent;

async function init() {
  const [ac, gr, sc, dg, pr] = await Promise.all([
    api('filters/academic-years'), api('filters/graduation-years'),
    api('filters/schools'), api('filters/degrees'), api('filters/programs')
  ]);
  if (ac.length) document.getElementById('fAcYear').value = ac[ac.length - 1].academic_year_id;

  document.getElementById('gradOpts').innerHTML = gr.map(y =>
    '<label style="display:flex;align-items:center;gap:10px;padding:6px 10px;border-radius:6px;cursor:pointer;font-size:13px;color:var(--text-secondary);font-weight:500" onmouseover="this.style.background=\'var(--bg-secondary)\'" onmouseout="this.style.background=\'transparent\'">' +
    '<input type="checkbox" value="' + y.graduation_year_id + '" class="gc" style="width:16px;height:16px;accent-color:var(--primary-color)" onchange="onGradChg()">' +
    y.graduation_year_name + '</label>'
  ).join('');
  selAllGrad();

  document.getElementById('fSchool').innerHTML = '<option value="">All Schools</option>' + sc.map(s => '<option value="' + s.school_id + '">' + s.school_name + '</option>').join('');
  document.getElementById('fDegree').innerHTML = '<option value="">All Degrees</option>' + dg.map(d => '<option value="' + d.certification_id + '">' + d.certification_name + (d.certification_short_name ? ' (' + d.certification_short_name + ')' : '') + '</option>').join('');
  document.getElementById('fProgram').innerHTML = '<option value="">All Programs</option>' + pr.map(p => '<option value="' + p.id + '">' + p.abbrivation + '</option>').join('');

  document.getElementById('totalSchools').textContent = sc.length;
  document.getElementById('totalPrograms').textContent = pr.length;
  document.getElementById('totalGradYears').textContent = gr.length;
  loadSummary();
  loadSchools();
}

function toggleGrad() {
  const d = document.getElementById('gradDD');
  d.style.display = d.style.display === 'none' ? 'block' : 'none';
}
document.addEventListener('click', e => {
  if (!e.target.closest('#gradBtn') && !e.target.closest('#gradDD'))
    document.getElementById('gradDD').style.display = 'none';
});
function selAllGrad() { document.querySelectorAll('.gc').forEach(c => c.checked = true); onGradChg(); }
function clrGrad() { document.querySelectorAll('.gc').forEach(c => c.checked = false); onGradChg(); }
function onGradChg() {
  const ck = [...document.querySelectorAll('.gc:checked')], t = document.querySelectorAll('.gc').length;
  document.getElementById('gradLabel').textContent = ck.length === 0 ? 'None' : ck.length === t ? 'All Years' : ck.length + ' Selected';
  onFilterChange();
}
function onFilterChange() { showLevel('schools'); loadSummary(); loadSchools(); }
function resetFilters() {
  selAllGrad();
  document.getElementById('fSchool').value = '';
  document.getElementById('fDegree').value = '';
  document.getElementById('fProgram').value = '';
  onFilterChange();
}

async function loadSummary() {
  try {
    const s = await api('summary');
    document.getElementById('totalStudents').textContent = (s.total_students || 0).toLocaleString();
  } catch (e) {}
}

function showLevel(lv) {
  S.level = lv;
  ['schoolsGrid','programsGrid','cohortsGrid','classesGrid'].forEach(id => {
    document.getElementById(id).style.display = 'none';
    document.getElementById(id).innerHTML = '';
  });
  document.getElementById(lv + 'Grid').style.display = 'grid';
  document.getElementById('loadingState').style.display = 'none';
  document.getElementById('emptyState').style.display = 'none';
  updateBC();
}

function chevHTML() {
  return '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--text-tertiary)" stroke-width="2.5" style="flex-shrink:0"><path d="m9 5 7 7-7 7"/></svg>';
}

function updateBC() {
  const b = document.getElementById('breadcrumb');
  let h = '<span style="cursor:pointer;font-weight:600;color:' + (S.level === 'schools' ? 'var(--primary-color)' : 'var(--text-tertiary)') + '" onclick="showLevel(\'schools\');loadSchools()">Schools</span>';
  if (['programs','cohorts','classes'].includes(S.level)) {
    h += chevHTML() + '<span style="cursor:pointer;font-weight:500;color:' + (S.level === 'programs' ? 'var(--text-primary)' : 'var(--text-tertiary)') + '" onclick="loadPrograms(' + S.curSchool.id + ',\'' + E(S.curSchool.name) + '\')">' + S.curSchool.name + '</span>';
  }
  if (['cohorts','classes'].includes(S.level)) {
    h += chevHTML() + '<span style="cursor:pointer;font-weight:500;color:' + (S.level === 'cohorts' ? 'var(--text-primary)' : 'var(--text-tertiary)') + '" onclick="loadCohorts(' + S.curSchool.id + ',' + S.curProg.id + ',\'' + E(S.curProg.name) + '\')">' + S.curProg.name + '</span>';
  }
  if (S.level === 'classes') {
    h += chevHTML() + '<span style="font-weight:600;color:var(--text-primary)">' + S.curCohort.name + '</span>';
  }
  b.innerHTML = h;
}

function mkCard(name, cnt, code, sub, click, i, extraRows) {
  const col = COLORS[i % COLORS.length];
  return '<div class="class-card" onclick="' + click + '" style="cursor:pointer" data-school="' + i + '">' +
    '<div class="card-subject">' +
      '<span class="subject-badge" style="background:' + col + '">' + (code || name.charAt(0)) + '</span>' +
      '<div class="subject-name">' + name + '</div>' +
    '</div>' +
    '<div class="card-info">' +
      '<div class="card-info-row">' +
        '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>' +
        '<span>' + cnt.toLocaleString() + ' Students</span>' +
      '</div>' +
      (extraRows || '') +
      '<div class="card-info-row">' +
        '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m9 5 7 7-7 7"/></svg>' +
        '<span style="color:var(--primary-color);font-weight:500">' + sub + '</span>' +
      '</div>' +
    '</div>' +
  '</div>';
}

function infoRow(icon, text) {
  var icons = {
    school: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16"/><path d="M3 21h18"/><path d="M9 7h1m-1 4h1m4-4h1m-1 4h1"/></svg>',
    program: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z"/></svg>',
    calendar: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>',
    grid: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>'
  };
  return '<div class="card-info-row">' + (icons[icon] || '') + '<span>' + text + '</span></div>';
}

function showLoading() {
  ['schoolsGrid','programsGrid','cohortsGrid','classesGrid'].forEach(id => document.getElementById(id).style.display = 'none');
  document.getElementById('emptyState').style.display = 'none';
  document.getElementById('loadingState').style.display = 'block';
}

function showEmpty(msg) {
  document.getElementById('loadingState').style.display = 'none';
  document.getElementById('emptyState').style.display = 'block';
  document.getElementById('emptyState').querySelector('h3').textContent = msg || 'No data found';
}

async function loadSchools() {
  showLoading();
  showLevel('schools');
  const g = document.getElementById('schoolsGrid');
  try {
    const d = await api('schools');
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('resultCount').textContent = d.length + ' school(s)';
    if (!d.length) { showEmpty('No schools found'); return; }
    g.style.display = 'grid';
    g.innerHTML = d.map((s, i) => mkCard(s.school_name, s.cnt, s.school_name.charAt(0), 'View programs', "loadPrograms(" + s.school_id + ",'" + E(s.school_name) + "')", i, infoRow('school', s.school_name))).join('');
  } catch (e) { showEmpty('Error: ' + e.message); }
}

async function loadPrograms(sid, sn) {
  sn = D(sn);
  S.curSchool = { id: sid, name: sn };
  showLoading();
  showLevel('programs');
  const g = document.getElementById('programsGrid');
  try {
    const d = await api('programs/' + sid);
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('resultCount').textContent = d.length + ' program(s)';
    if (!d.length) { showEmpty('No programs found'); return; }
    g.style.display = 'grid';
    g.innerHTML = d.map((p, i) => mkCard(p.program_name, p.cnt, p.program_code || 'P', 'View cohorts', "loadCohorts(" + sid + "," + p.program_id + ",'" + E(p.program_name) + "')", i, infoRow('school', S.curSchool.name) + infoRow('program', p.program_code || 'Program'))).join('');
  } catch (e) { showEmpty('Error: ' + e.message); }
}

async function loadCohorts(sid, pid, pn) {
  pn = D(pn);
  S.curProg = { id: pid, name: pn };
  showLoading();
  showLevel('cohorts');
  const g = document.getElementById('cohortsGrid');
  try {
    const d = await api('cohorts/' + sid + '/' + pid);
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('resultCount').textContent = d.length + ' cohort(s)';
    if (!d.length) { showEmpty('No cohorts found'); return; }
    g.style.display = 'grid';
    g.innerHTML = d.map((c, i) => mkCard(c.cluster_name, c.cnt, c.cluster_code || 'C', 'View divisions', "loadClasses(" + c.cluster_id + ",'" + E(c.cluster_name) + "')", i, infoRow('school', S.curSchool.name) + infoRow('program', S.curProg.name) + (c.graduation_year_name ? infoRow('calendar', 'Grad: ' + c.graduation_year_name) : ''))).join('');
  } catch (e) { showEmpty('Error: ' + e.message); }
}

async function loadClasses(cid, cn) {
  cn = D(cn);
  S.curCohort = { id: cid, name: cn };
  showLoading();
  showLevel('classes');
  const g = document.getElementById('classesGrid');
  try {
    const d = await api('classes/' + cid);
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('resultCount').textContent = d.length + ' division(s)';
    if (!d.length) { showEmpty('No divisions found'); return; }
    g.style.display = 'grid';
    g.innerHTML = d.map((cl, i) => mkCard(cl.st_class_name, cl.cnt, cl.st_class_code || 'D', 'View students', "goStudents(" + cl.st_class_id + ",'" + E(cl.st_class_name) + "')", i, infoRow('school', S.curSchool.name) + infoRow('program', S.curProg.name) + infoRow('grid', S.curCohort.name))).join('');
  } catch (e) { showEmpty('Error: ' + e.message); }
}

function goStudents(cid, cn) {
  window.location.href = '/student-count/students?class_id=' + cid + '&class_name=' + cn +
    '&school=' + E(S.curSchool.name) + '&program=' + E(S.curProg.name) +
    '&cohort=' + E(S.curCohort.name) + '&' + bq();
}

init();
</script>

  </div>
</div>
</body>
</html>
